(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function t(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=t(n);fetch(n.href,r)}})();class c{constructor(){this.manifest=null,this.assetsMap=new Map,this.placeholders={bg:"PLACEHOLDER_BG",char:"PLACEHOLDER_CHAR",prop:"PLACEHOLDER_PROP"}}async init(e="assets/manifest.json"){try{const t=await fetch(e);this.manifest=await t.json(),this.manifest.assets.forEach(s=>{this.assetsMap.set(s.id,s)}),console.log(`[AssetManager] Loaded ${this.assetsMap.size} assets from manifest`)}catch(t){throw console.error("[AssetManager] Failed to load manifest:",t),t}}getAsset(e,t=null){if(this.assetsMap.has(e))return this.assetsMap.get(e);console.warn(`[AssetManager] Asset not found: ${e}, using placeholder`);const s=t?this.placeholders[t]:this.placeholders.prop;return this.assetsMap.has(s)?this.assetsMap.get(s):(console.error(`[AssetManager] Placeholder not found: ${s}`),{id:s,type:t||"unknown",path:"assets/placeholders/missing.svg"})}async preloadAssets(e){const t=e.map(s=>{const n=this.getAsset(s);return this.loadImage(n.path)});try{await Promise.all(t),console.log(`[AssetManager] Preloaded ${e.length} assets`)}catch(s){console.warn("[AssetManager] Some assets failed to preload:",s)}}loadImage(e){return new Promise((t,s)=>{const n=new Image;n.onload=()=>t(n),n.onerror=()=>s(new Error(`Failed to load image: ${e}`)),n.src=e})}getAllAssets(){return Array.from(this.assetsMap.values())}getAssetsByType(e){return this.getAllAssets().filter(t=>t.type===e)}}const o=assetManager;class l{constructor(){this.vocabData=null,this.currentScene=null}async init(e="content/side/vocab.json"){try{const t=await fetch(e);this.vocabData=await t.json(),console.log(`[StoryRenderer] Loaded ${this.vocabData.vocabs.length} vocab entries`)}catch(t){console.warn("[StoryRenderer] Failed to load vocab data:",t),this.vocabData={version:"1.0",vocabs:[]}}}async loadScene(e){try{const s=await(await fetch(e)).text();return this.currentScene=s,s}catch(t){throw console.error("[StoryRenderer] Failed to load scene:",t),t}}renderScene(e,t){if(!t){console.error("[StoryRenderer] No container provided");return}let s=e;s=this.processBgTags(s),s=this.processCharTags(s),s=this.processPropTags(s),s=this.processVocabTags(s),t.innerHTML=this.markdownToHtml(s)}processBgTags(e){return e.replace(/\[\[bg:(\w+)\]\]/g,(t,s)=>{const n=o.getAsset(s,"bg");return`<div class="bg-container" data-bg-id="${s}"><img src="${n.path}" alt="Background: ${s}" class="background-image" /></div>`})}processCharTags(e){return e.replace(/\[\[char:(\w+):(\w+)\]\]/g,(t,s,n)=>{const r=`${s}_${n}`,i=o.getAsset(r,"char");return(!i||i.id.startsWith("PLACEHOLDER"))&&console.warn(`[StoryRenderer] Character asset not found: ${r}`),`<div class="char-container" data-char="${s}" data-emotion="${n}"><img src="${i.path}" alt="${s} (${n})" class="character-image" /></div>`})}processPropTags(e){return e.replace(/\[\[prop:(\w+)\]\]/g,(t,s)=>{const n=o.getAsset(s,"prop");return`<div class="prop-container" data-prop-id="${s}"><img src="${n.path}" alt="Prop: ${s}" class="prop-image" /></div>`})}processVocabTags(e){return e.replace(/\[\[vocab:(\w+)\]\]/g,(t,s)=>{const n=this.getVocabById(s);return n?`<span class="vocab-term" data-vocab-id="${s}" title="${n.definition}">${n.lemma}</span>`:(console.warn(`[StoryRenderer] Vocab not found: ${s}`),`<span class="vocab-missing" data-vocab-id="${s}">${s}</span>`)})}getVocabById(e){return!this.vocabData||!this.vocabData.vocabs?null:this.vocabData.vocabs.find(t=>t.id===e)}markdownToHtml(e){let t=e;return t=t.replace(/^### (.+)$/gm,"<h3>$1</h3>"),t=t.replace(/^## (.+)$/gm,"<h2>$1</h2>"),t=t.replace(/^# (.+)$/gm,"<h1>$1</h1>"),t=t.replace(/\*\*(.+?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/\*(.+?)\*/g,"<em>$1</em>"),t=t.replace(/^---$/gm,"<hr>"),t=t.replace(/\n\n/g,"</p><p>"),t="<p>"+t+"</p>",t=t.replace(/<p><\/p>/g,""),t=t.replace(/<p>\s*<hr>\s*<\/p>/g,"<hr>"),t=t.replace(/<p>\s*<h([1-6])>/g,"<h$1>"),t=t.replace(/<\/h([1-6])>\s*<\/p>/g,"</h$1>"),t}}class h{constructor(){this.storageKey="visualNovelSave",this.currentSave=null}init(){this.loadSave(),console.log("[SaveManager] Initialized")}loadSave(){try{const e=localStorage.getItem(this.storageKey);e?(this.currentSave=JSON.parse(e),console.log("[SaveManager] Save loaded:",this.currentSave)):(this.currentSave=this.createNewSave(),console.log("[SaveManager] No save found, created new save"))}catch(e){console.error("[SaveManager] Failed to load save:",e),this.currentSave=this.createNewSave()}return this.currentSave}createNewSave(){return{version:"1.0",timestamp:Date.now(),progress:{currentSceneId:"DEMO_S01",currentLine:0,completedScenes:[]},learning:{learnedVocabs:[],vocabProgress:{},studyTime:0},settings:{textSpeed:"normal",autoPlay:!1,volume:.8}}}save(){try{return this.currentSave.timestamp=Date.now(),localStorage.setItem(this.storageKey,JSON.stringify(this.currentSave)),console.log("[SaveManager] Save successful"),!0}catch(e){return console.error("[SaveManager] Failed to save:",e),!1}}updateSceneProgress(e,t=0){this.currentSave.progress.currentSceneId=e,this.currentSave.progress.currentLine=t,this.currentSave.progress.completedScenes.includes(e)||this.currentSave.progress.completedScenes.push(e),this.save()}learnVocab(e){this.currentSave.learning.learnedVocabs.includes(e)||this.currentSave.learning.learnedVocabs.push(e),this.currentSave.learning.vocabProgress[e]||(this.currentSave.learning.vocabProgress[e]={firstSeen:Date.now(),reviewCount:0,lastReview:null,mastery:0}),this.currentSave.learning.vocabProgress[e].reviewCount++,this.currentSave.learning.vocabProgress[e].lastReview=Date.now(),this.save()}getProgress(){return this.currentSave.progress}getLearningStatus(){return this.currentSave.learning}updateSettings(e){this.currentSave.settings={...this.currentSave.settings,...e},this.save()}exportSave(){return JSON.stringify(this.currentSave,null,2)}importSave(e){try{const t=JSON.parse(e);return this.currentSave=t,this.save(),console.log("[SaveManager] Save imported successfully"),!0}catch(t){return console.error("[SaveManager] Failed to import save:",t),!1}}resetSave(){this.currentSave=this.createNewSave(),this.save(),console.log("[SaveManager] Save reset")}}class d{constructor(e){this.container=document.getElementById(e),this.mode="read",this.currentSpeaker="",this.currentText="",this.currentTag="",this.init()}init(){this.container.innerHTML=`
      <div class="dialog-box mode-${this.mode}">
        <div class="dialog-nameplate">
          <span class="dialog-name"></span>
          <span class="dialog-tag"></span>
        </div>
        <div class="dialog-content">
          <p class="dialog-text"></p>
        </div>
        <div class="dialog-continue"></div>
      </div>
    `,this.elements={box:this.container.querySelector(".dialog-box"),name:this.container.querySelector(".dialog-name"),tag:this.container.querySelector(".dialog-tag"),content:this.container.querySelector(".dialog-content"),text:this.container.querySelector(".dialog-text"),continueIndicator:this.container.querySelector(".dialog-continue")}}setMode(e){this.mode=e,this.elements.box.className=`dialog-box mode-${e}`}show(e,t,s="",n=!0){this.currentSpeaker=e,this.currentText=t,this.currentTag=s,this.elements.name.textContent=e,this.elements.tag.textContent=s,this.elements.tag.style.display=s?"inline-block":"none",this.elements.text.textContent=t,n&&(this.elements.box.classList.remove("settle-effect"),this.elements.box.offsetWidth,this.elements.box.classList.add("settle-effect")),this.showContinueIndicator()}showNarration(e,t=!0){this.show("ÊóÅÁôΩ",e,"",t),this.elements.nameplate=this.container.querySelector(".dialog-nameplate"),this.elements.nameplate.style.opacity="0.7"}showContinueIndicator(){this.elements.continueIndicator.style.display="block",this.elements.continueIndicator.classList.add("continue-indicator")}hideContinueIndicator(){this.elements.continueIndicator.style.display="none",this.elements.continueIndicator.classList.remove("continue-indicator")}clear(){this.elements.name.textContent="",this.elements.tag.textContent="",this.elements.text.textContent="",this.hideContinueIndicator()}addStatusBadge(e,t="info"){const s=this.elements.content.querySelector(".status-badge");s&&s.remove();const n=document.createElement("div");n.className=`status-badge ${t}`,n.textContent=e,this.elements.content.appendChild(n)}removeStatusBadge(){const e=this.elements.content.querySelector(".status-badge");e&&e.remove()}getCurrentContent(){return{speaker:this.currentSpeaker,text:this.currentText,tag:this.currentTag,mode:this.mode}}}class u{constructor(e){this.container=document.getElementById(e),this.actions=[],this.selectedAction=null,this.onSelectCallback=null,this.init()}init(){this.container.innerHTML='<div class="action-bar"></div>',this.actionBar=this.container.querySelector(".action-bar")}setActions(e){this.actions=e,this.selectedAction=null,this.render()}render(){this.actionBar.innerHTML="",this.actions.forEach((e,t)=>{const s=document.createElement("div");s.className="action-item",s.dataset.actionId=e.id,e.disabled&&s.classList.add("disabled"),s.innerHTML=`
        <span class="action-verb">„Äî${e.verb}„Äï</span>
        <span class="action-text">${e.text}</span>
      `,e.disabled||s.addEventListener("click",()=>this.selectAction(e.id)),s.style.animationDelay=`${t*50}ms`,s.classList.add("settle-effect"),this.actionBar.appendChild(s)})}selectAction(e){if(this.selectedAction)return;this.selectedAction=e;const t=this.actionBar.querySelector(`[data-action-id="${e}"]`);if(!t)return;t.classList.add("selected","stamp-effect"),this.actionBar.querySelectorAll(".action-item").forEach(n=>{n!==t&&(n.style.opacity="0.5",n.style.pointerEvents="none")}),this.onSelectCallback&&setTimeout(()=>{this.onSelectCallback(e)},300)}onSelect(e){this.onSelectCallback=e}clear(){this.actionBar.innerHTML="",this.actions=[],this.selectedAction=null}show(){this.container.style.display="block"}hide(){this.container.style.display="none"}getSelectedAction(){return this.selectedAction}reset(){this.selectedAction=null,this.actionBar.querySelectorAll(".action-item").forEach(t=>{t.classList.remove("selected","stamp-effect"),t.style.opacity="1",t.style.pointerEvents="auto"})}}class g{constructor(e){this.container=document.getElementById(e),this.povs=[],this.currentPOV=null,this.onSwitchCallback=null,this.init()}init(){this.container.innerHTML='<div class="pov-switcher"></div>',this.switcher=this.container.querySelector(".pov-switcher")}setPOVs(e){this.povs=e,this.render()}render(){this.switcher.innerHTML="",this.povs.forEach(e=>{const t=document.createElement("button");t.className="pov-button",t.dataset.povId=e.id,t.textContent=e.name,e.locked?(t.disabled=!0,t.style.opacity="0.3",t.title="Êú™Ëß£ÈîÅ"):t.addEventListener("click",()=>this.switchPOV(e.id)),e.id===this.currentPOV&&t.classList.add("active"),this.switcher.appendChild(t)})}switchPOV(e){if(this.currentPOV===e)return;const t=this.currentPOV;this.currentPOV=e,this.switcher.querySelectorAll(".pov-button").forEach(n=>{n.dataset.povId===e?(n.classList.add("active"),n.classList.add("nameplate-change")):n.classList.remove("active")}),this.onSwitchCallback&&this.onSwitchCallback(e,t)}onSwitch(e){this.onSwitchCallback=e}getCurrentPOV(){return this.currentPOV}unlockPOV(e){const t=this.povs.find(s=>s.id===e);t&&(t.locked=!1,this.render())}lockPOV(e){const t=this.povs.find(s=>s.id===e);t&&(t.locked=!0,this.render())}show(){this.container.style.display="block"}hide(){this.container.style.display="none"}}class v{constructor(e){this.container=document.getElementById(e),this.currentScene=0,this.totalScenes=0,this.sceneTitle="",this.onNavigateCallback=null,this.init()}init(){this.container.innerHTML=`
      <div class="scene-navigator">
        <button class="nav-button nav-prev" title="‰∏ä‰∏ÄÂú∫ÊôØ">‚Äπ</button>
        <div class="scene-title"></div>
        <button class="nav-button nav-next" title="‰∏ã‰∏ÄÂú∫ÊôØ">‚Ä∫</button>
      </div>
    `,this.elements={navigator:this.container.querySelector(".scene-navigator"),prevBtn:this.container.querySelector(".nav-prev"),nextBtn:this.container.querySelector(".nav-next"),title:this.container.querySelector(".scene-title")},this.elements.prevBtn.addEventListener("click",()=>this.previous()),this.elements.nextBtn.addEventListener("click",()=>this.next()),this.updateButtons()}setScene(e,t,s){this.currentScene=e,this.totalScenes=t,this.sceneTitle=s,this.elements.title.textContent=`${s} (${e+1}/${t})`,this.updateButtons()}updateButtons(){this.elements.prevBtn.disabled=this.currentScene<=0,this.elements.nextBtn.disabled=this.currentScene>=this.totalScenes-1}previous(){this.currentScene>0&&this.navigate(this.currentScene-1)}next(){this.currentScene<this.totalScenes-1&&this.navigate(this.currentScene+1)}navigate(e){if(e<0||e>=this.totalScenes)return;const t=this.currentScene;this.currentScene=e,this.updateButtons(),this.onNavigateCallback&&this.onNavigateCallback(e,t)}onNavigate(e){this.onNavigateCallback=e}getCurrentScene(){return this.currentScene}show(){this.container.style.display="block"}hide(){this.container.style.display="none"}goToFirst(){this.navigate(0)}goToLast(){this.navigate(this.totalScenes-1)}}class p{constructor(){this.assetManager=null,this.storyRenderer=null,this.saveManager=null,this.dialogBox=null,this.actionBar=null,this.povSwitcher=null,this.sceneNavigator=null,this.currentScene=0,this.currentNode=0,this.storyIndex=null,this.isInitialized=!1}async init(){console.log("üöÄ Initializing Murder Mystery Framework...");try{this.assetManager=new c,await this.assetManager.loadManifest(),this.saveManager=new h,this.dialogBox=new d("dialog-box"),this.actionBar=new u("action-bar"),this.povSwitcher=new g("pov-switcher"),this.sceneNavigator=new v("scene-navigator"),await this.loadStoryIndex(),this.storyRenderer=new l(this.assetManager,this.saveManager),this.setupEventListeners(),await this.loadProgress(),this.isInitialized=!0,console.log("‚úÖ Application initialized successfully"),this.startStory()}catch(e){console.error("‚ùå Failed to initialize application:",e),this.showError("ÂàùÂßãÂåñÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÈáçËØï„ÄÇ")}}async loadStoryIndex(){try{const e=await fetch("content/story_index.json");this.storyIndex=await e.json(),console.log(`‚úì Loaded ${this.storyIndex.scenes.length} scenes`)}catch(e){throw console.error("Failed to load story index:",e),e}}setupEventListeners(){this.actionBar.onSelect(e=>{this.handleActionSelect(e)}),this.povSwitcher.onSwitch((e,t)=>{this.handlePOVSwitch(e,t)}),this.sceneNavigator.onNavigate((e,t)=>{this.handleSceneNavigate(e,t)}),document.addEventListener("click",e=>{e.target.closest(".dialog-continue")&&this.continueStory()}),document.addEventListener("keydown",e=>{e.key==="Enter"||e.key===" "?this.continueStory():e.key==="ArrowLeft"?this.sceneNavigator.previous():e.key==="ArrowRight"&&this.sceneNavigator.next()})}async loadProgress(){const e=this.saveManager.loadGame();e&&e.currentScene!==void 0&&(this.currentScene=e.currentScene,this.currentNode=e.currentNode||0,console.log(`‚úì Loaded save: Scene ${this.currentScene}, Node ${this.currentNode}`))}async startStory(){if(!this.storyIndex||this.storyIndex.scenes.length===0){this.showError("Ê≤°ÊúâÂèØÁî®ÁöÑÊïÖ‰∫ãÂÜÖÂÆπ„ÄÇ");return}const e=this.storyIndex.scenes[this.currentScene];this.sceneNavigator.setScene(this.currentScene,this.storyIndex.scenes.length,e.title),await this.loadScene(this.currentScene)}async loadScene(e){const t=this.storyIndex.scenes[e];if(!t){console.error("Scene not found:",e);return}console.log(`Loading scene: ${t.title}`),`${t.source}${t.sceneId}`;try{this.dialogBox.setMode("read"),this.dialogBox.show("ÊóÅÁôΩ",`Ê≠£Âú®Âä†ËΩΩÂú∫ÊôØÔºö${t.title}

ËøôÊòØ‰∏Ä‰∏™ÊºîÁ§∫ÁïåÈù¢„ÄÇËØ∑Â∞ÜÊïÖ‰∫ãÂÜÖÂÆπÊîæÂÖ• content/_source/main.docxÔºåÁÑ∂ÂêéËøêË°å npm run story:import ÂØºÂÖ•ÂÜÖÂÆπ„ÄÇ`,"",!0),this.actionBar.hide(),this.povSwitcher.setPOVs([{id:"narrator",name:"ÊóÅÁôΩ"},{id:"player",name:"Áé©ÂÆ∂",locked:!0}]),this.povSwitcher.switchPOV("narrator")}catch(s){console.error("Failed to load scene:",s),this.showError("Âú∫ÊôØÂä†ËΩΩÂ§±Ë¥•„ÄÇ")}}continueStory(){this.actionBar.setActions([{id:"investigate",verb:"Ë∞ÉÊü•",text:"‰ªîÁªÜÊü•ÁúãÂë®Âõ¥ÁéØÂ¢É"},{id:"talk",verb:"‰∫§Ë∞à",text:"‰∏éÂú®Âú∫‰∫∫ÂëòÂØπËØù"},{id:"think",verb:"ÊÄùËÄÉ",text:"Êï¥ÁêÜÂ∑≤Áü•Á∫øÁ¥¢"}]),this.actionBar.show()}handleActionSelect(e){console.log("Action selected:",e),this.dialogBox.show("Á≥ªÁªü",`‰Ω†ÈÄâÊã©‰∫ÜË°åÂä®Ôºö${e}

ËøôÊòØÊºîÁ§∫ÂÜÖÂÆπ„ÄÇÂÆûÈôÖÊ∏∏Êàè‰∏≠ÔºåËøôÈáå‰ºöÊ†πÊçÆ‰Ω†ÁöÑÈÄâÊã©Â±ïÁ§∫‰∏çÂêåÁöÑÂâßÊÉÖ„ÄÇ`,"",!0),this.actionBar.hide(),this.saveProgress()}handlePOVSwitch(e,t){console.log(`POV switched: ${t} -> ${e}`);const s=document.getElementById("char-layer");s.classList.add("spotlight-on"),setTimeout(()=>{s.classList.remove("spotlight-on")},200)}async handleSceneNavigate(e,t){console.log(`Scene navigate: ${t} -> ${e}`),this.currentScene=e,this.currentNode=0;const s=document.querySelector(".bg-container");s.classList.add("fade-out"),setTimeout(async()=>{await this.loadScene(e),s.classList.remove("fade-out")},200),this.saveProgress()}saveProgress(){this.saveManager.saveGame({currentScene:this.currentScene,currentNode:this.currentNode,timestamp:Date.now()})}showError(e){this.dialogBox.setMode("read"),this.dialogBox.show("Á≥ªÁªü",e,"ÈîôËØØ",!1)}}document.addEventListener("DOMContentLoaded",()=>{const a=new p;a.init(),window.app=a});
